{% extends 'app/layout.html' %}
{% load staticfiles %}
{% load bootstrap_components %}

{% block content %}
<h1>{{ project.name }}</h1>

<div id="map"></div>

<p>{{ project.description|linebreaks }}</p>

{% if user.is_authenticated %}
    <div>
        <a class='btn btn-primary pull-right'
            href="{% url 'project-edit' project.id %}">Edit Project &raquo;</a>
    </div>
{% endif %}

<h2>Scenarios</h2>
<div>
    {% for r in project.projectscenariorelationship_set.all %}
        <div class='row'>
            <a class='h4' href="{% url 'scenario' r.scenario.id %}">{{ r.scenario.name }}</a>
            {% if user.is_authenticated %}
                <button class="btn btn-link btn-xs remove-scenario-button"
                    data-rel-id="{{ r.id }}">
                    (remove)</button>
            {% endif %}
            <p>{{ r.scenario.description }}</p>
        </div>
    {% empty %}
        {% if user.is_authenticated %}
            <p class="lead">
                You haven't defined any scenarios for this project. Add a
                scenario using the button below.
            </p>
        {% else %}
            <p class="lead">
                The owner of this project has not yet defined any flow
                scenarios.
            </p>
        {% endif %}
    {% endfor %}

    {% if user.is_authenticated %}
        <button type="button" class="btn btn-primary pull-right"
            data-toggle="modal" data-target="#add-scenario-modal">
            Add a scenario
        </button>
    {% endif %}
</div>

{% if project.scenarios.all|length > 0 %}

<h2>Indicators</h2>

<div>
    <h3>Environmental Flow Sufficiency</h3>
    <div>
        <h4>Temporal Deficit {% bootstrap_modal_show "eflow-temporal-deficit-help" %}</h4>
        <div class='row'>
            <div class="col-md-6">
                <img id="percent-plot" src="{% static 'app/images/white_pixel.png' %}" class="dynamic-image"></img>
            </div>
            <div class="col-md-6">
                <h5>Monthly Temporal Deficit</h5>
                <div id="deficit-pct-table-monthly"></div>
                <h5>Annual Temporal Deficit</h5>
                <div id="deficit-pct-table-annual"></div>
            </div>
        </div>
        <h4>Volumetric Deficit {% bootstrap_modal_show "eflow-volumetric-deficit-help" %}</h4>
        <div class='row'>
            <div class="col-md-6">
                <img id="deficit-pct-plot" src="{% static 'app/images/white_pixel.png' %}" class="dynamic-image"></img>
            </div>
            <div class="col-md-6">
                <h5>Monthly Volume Deficit</h5>
                <div id="deficit-stats-monthly-pct-table"></div>
                <h5>Annual Volume Deficit</h5>
                <div id="deficit-stats-annual-pct-table"></div>
            </div>
        </div>
        <div class='row'>
            <div class="col-md-6">
                <img id="deficit-plot" src="{% static 'app/images/white_pixel.png' %}" class="dynamic-image"></img>
            </div>
            <div class="col-md-6">
                <h5>Monthly Volume Deficit</h5>
                <div id="deficit-stats-monthly-table"></div>
                <h5>Annual Volume Deficit</h5>
                <div id="deficit-stats-annual-table"></div>
            </div>
        </div>
    </div>

    <h3>Long-term Hydrologic Trend</h3>
    <div class="row">
        <h4>7-Day Minimum Flow Trend</h4>
        <div class="col-md-6">
            <img id="low-flow-plot" src="{% static 'app/images/white_pixel.png' %}" class="dynamic-image"></img>
        </div>
        <div class="col-md-6">
            <div id="low-flow-table"></div>
        </div>
    </div>

</div>

{% endif %}

{% include "utils/wait_dialog.django.html" with id="pleaseWaitDialog" loading_message="Loading data..." %}
{% include "flowviz/indicator_help.django.html" %}

{% if user.is_authenticated %}
<div class="modal fade" id="add-scenario-modal" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Add a scenario</h4>
            </div>
            <div class="modal-body">
                <form action="{% url 'list-project-scenario-relationship' %}" method="post">
                    {% csrf_token %}
                    <div id="scenario-selection" class="row">
                        <div class="col-md-6 col-md-offset-3">
                            {% include 'utils/bootstrap_form_element.django.html' with form=add_scenario_form %}
                        </div>
                    </div>
                    <p class="row text-center lead text-uppercase">Or</p>
                    <div class="row form-group">
                        <div class="col-md-6 col-md-offset-3">
                            <a class="btn btn-default"
                                href="{% url 'project-new-scenario' project.id %}"
                                id="new-scenario-button">
                                Create a new scenario &raquo;
                            </a>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="add-scenario-button" type="button" class="btn btn-primary">Add scenario</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script type="text/javascript" src="{% static 'flowviz/d3.min.js' %}"></script>
<script type="text/javascript" src="{% static 'flowviz/vega.js' %}"></script>
<script type="text/javascript" src="{% static 'flowviz/cedar.js' %}"></script>
<script type="text/javascript" src="{% static 'flowviz/common.js' %}"></script>
<script type="text/javascript" src="{% static 'flowviz/project_compare.js' %}"></script>
<script type="text/javascript" src="{% static 'utils/client.js' %}"></script>

<!-- Load Leaflet from CDN-->
<link rel="stylesheet" href="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.css" />
<script src="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.js"></script>

<!-- Load Esri Leaflet from CDN -->
<script src="//cdn.jsdelivr.net/leaflet.esri/1.0.0/esri-leaflet.js"></script>

<script type="text/javascript">
    var __tables = {
        "deficit-pct-table-monthly": "{% url 'project_deficit_days_csv' project.id %}",
        "deficit-pct-table-annual": "{% url 'project_deficit_days_annual_csv' project.id %}",
        "deficit-stats-monthly-pct-table": "{% url 'project_deficit_stats_pct_csv' project.id %}",
        "deficit-stats-annual-pct-table": "{% url 'project_deficit_stats_annual_pct_csv' project.id %}",
        "deficit-stats-monthly-table": "{% url 'project_deficit_stats_csv' project.id %}",
        "deficit-stats-annual-table": "{% url 'project_deficit_stats_annual_csv' project.id %}",
        "low-flow-table": "{% url 'project_low_flow_csv' project.id %}",
    };

    var imgUrls = {
        percent: "{% url 'project_pct_plot' project.id %}",
        deficit_pct: "{% url 'project_stats_pct_plot' project.id %}",
        deficit: "{% url 'project_stats_plot' project.id %}",
        low_flow: "{% url 'project_low_flow_plot' project.id %}"
    }

    var hucInfo = {
        'scale': "{{ huc_scale }}",
        'regions': {{ huc_regions | safe }},
    };

    var usgsGages = {{ usgs_gages | safe }};

    var gisLayers = {{ gis_layers | safe }};

    var addScenarioPostUrl = "{% url 'list-project-scenario-relationship' %}";
    var scenarioSelectId = "{{ add_scenario_form.scenario.id_for_label }}";
    var projectId = {{ project.id }};

    $(document).ready(function () {
        ProjectCompare.initialize(__tables, imgUrls, hucInfo, usgsGages, gisLayers);
    });
</script>
{% endblock %}
